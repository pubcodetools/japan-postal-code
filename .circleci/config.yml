version: 2.1

orbs:
  maven: circleci/maven@1.1
  sonatype: sonatype-nexus-community/circleci-maven-release-orb@0.0.16
  sonatype-dryrun: sonatype-nexus-community/circleci-maven-release-orb@0.0.16

executors:
  openjdk8:
    docker:
      - image: circleci/openjdk:8-jdk

jobs:
  notify:
    executor: openjdk8
    steps:
      - run: echo "notify"

custom_filters:
  main_only: &main_only
    filters:
      branches:
        only: main
  main_ignore: &main_ignore
    filters:
      branches:
        ignore: main

workflows:
  maven_test:
    jobs:
      - maven/test:
          <<: *main_ignore
          executor: openjdk8
          command: package
  maven_release:
    jobs:
      - maven/test:
          <<: *main_only
          executor: openjdk8
          command: test
      - sonatype-dryrun/run-maven-release:
          <<: *main_only
          requires:
            - maven/test
          mvn-release-perform-command: |
            mvn --batch-mode release:perform -DdryRun=true -s .circleci/.maven.xml
          mvn-release-prepare-command: |
            mvn --batch-mode release:prepare -DscmCommentPrefix="[skip ci][maven-release-plugin] " -DdryRun=true -s .circleci/.maven.xml
          ssh-fingerprints: 68:c0:1b:f2:32:d4:0d:c5:6f:56:1e:d8:c4:54:56:c9
      - notify:
          <<: *main_only
          requires:
            - sonatype-dryrun/run-maven-release
      - approve:
          type: approval
          <<: *main_only
          requires:
            - notify
      - sonatype/run-maven-release:
          <<: *main_only
          requires:
            - approve
          ssh-fingerprints: 68:c0:1b:f2:32:d4:0d:c5:6f:56:1e:d8:c4:54:56:c9